---
title: Notification Engine
description: Channel routing, deduplication, severity tiers, and storm batching for AOF events.
sidebar:
  order: 6
---

import { Aside } from '@astrojs/starlight/components';

The AOF notification engine routes task lifecycle events to configured notification channels. It provides deterministic rules (no LLM decisions), deduplication, and storm batching to prevent alert fatigue.

## How It Works

```
AOF Event (task.completed, heartbeat.stale, ...)
          ‚îÇ
          ‚ñº
  Notification Service
  ‚îú‚îÄ‚îÄ Rule evaluation (event type + conditions)
  ‚îú‚îÄ‚îÄ Severity classification
  ‚îú‚îÄ‚îÄ Deduplication (5-min window per event/task)
  ‚îú‚îÄ‚îÄ Storm batching (high-volume periods)
  ‚îî‚îÄ‚îÄ Channel routing
          ‚îÇ
          ‚îú‚îÄ‚îÄ Matrix channel
          ‚îú‚îÄ‚îÄ Console (development)
          ‚îî‚îÄ‚îÄ Custom adapters
```

## Notification Rules

### Task State Transitions

| Event | Condition | Channel | Template |
|-------|-----------|---------|----------|
| `task.assigned` | backlog ‚Üí ready | `#aof-dispatch` | `üì¨ Task {id} assigned to {agent}: {title}` |
| `task.started` | Lease acquired | `#aof-dispatch` | `‚ñ∂Ô∏è {agent} started {id}: {title}` |
| `task.completed` | ‚Üí done | `#aof-dispatch` | `‚úÖ {agent} completed {id}: {title}` |
| `task.review` | ‚Üí review | `#aof-review` | `üëÄ {id} ready for review: {title}` |
| `task.blocked` | ‚Üí blocked | `#aof-alerts` | `üöß {id} blocked: {title} ({reason})` |

### Recovery & Staleness

| Event | Condition | Channel | Severity |
|-------|-----------|---------|---------|
| `heartbeat.stale` | Heartbeat expired | `#aof-alerts` | warning |
| `lease.expired` | Lease TTL exceeded | `#aof-alerts` | warning |
| `task.abandoned` | Crash detected | `#aof-alerts` | critical |
| `task.deadletter` | 3 dispatch failures | `#aof-alerts` | error |

### Drift & Configuration

| Event | Channel | Severity |
|-------|---------|---------|
| `drift.detected` | `#aof-alerts` | warning |
| `memory.drift` | `#aof-alerts` | warning |
| `config.invalid` | `#aof-alerts` | error |

### Health & Metrics

| Event | Condition | Severity |
|-------|-----------|---------|
| `scheduler.down` | >3 consecutive failures | critical |
| `scheduler.recovered` | Polls resume | info |
| `metrics.anomaly` | Queue depth >20 for >10min | warning |

## Deduplication

The notification engine suppresses duplicate notifications within a 5-minute window:

```
Event: task.blocked for TASK-2026-02-21-001
 at 15:00:00 ‚Üí SENT
 at 15:02:00 ‚Üí SUPPRESSED (within 5min window)
 at 15:05:30 ‚Üí SENT (window expired, resend)
```

**Dedup key:** `(taskId, eventType)` ‚Äî per-task, per-type deduplication.

**Exceptions (never suppressed):**
- `scheduler.down`
- `task.abandoned`
- Any event with severity `critical`

## Storm Batching

During high-activity periods (e.g., a batch completion run), the engine batches notifications to avoid flooding:

```
Normal mode:  Send each notification individually
Storm mode:   Aggregate events for 30s, then send summary

Storm trigger: >10 notifications in 60s window
Storm message: "üå©Ô∏è Storm mode: 47 events in last 60s ‚Äî [summary]"
```

Storm batching prevents a 100-task batch completion from sending 100 Slack/Matrix messages.

## Severity Tiers

| Severity | Description | Examples |
|----------|-------------|---------|
| `info` | Normal operational events | task completed, task started |
| `warning` | Attention needed, not urgent | heartbeat stale, drift detected |
| `error` | Action required | deadletter, config invalid |
| `critical` | Immediate intervention | scheduler down, task abandoned |

Critical events bypass deduplication and storm batching.

## Channel Routing

Channels are configured in the OpenClaw plugin config or standalone config. With Matrix integration:

```json
{
  "notifications": {
    "channels": {
      "dispatch": "#aof-dispatch",
      "alerts": "#aof-alerts",
      "review": "#aof-review",
      "critical": "#aof-critical"
    }
  }
}
```

## Notification Adapters

| Adapter | Status | Description |
|---------|--------|-------------|
| `MatrixNotifier` | Production | Matrix room notifications via OpenClaw gateway |
| `ConsoleNotifier` | Development | Logs notifications to stdout |
| Custom | Extensible | Implement `NotificationAdapter` interface |

To implement a custom adapter, implement the `NotificationAdapter` interface from `src/events/notifier.ts`.

<Aside type="note">
Matrix integration is available when running in OpenClaw plugin mode. The Matrix notifier uses the OpenClaw gateway's Matrix client to send messages to configured rooms.
</Aside>
