---
title: Workflow Gates
description: Multi-stage SDLC enforcement with rejection loops, role-based routing, and conditional gates.
sidebar:
  order: 3
---

import { Aside } from '@astrojs/starlight/components';

**Workflow gates** are AOF's mechanism for enforcing multi-stage processes. They define discrete checkpoints where a specific role must review, validate, or approve work before a task can proceed — agents cannot skip gates, bypass reviews, or advance without the correct role.

## Core Concepts

A **workflow** is a sequence of gates. Each gate has:
- A **role** that must complete it (resolved via the org chart's `roles` mapping)
- Whether it `canReject` (send work back to the origin gate)
- Optional **conditions** (skip this gate if the condition is false)
- Optional **timeout** and **escalateTo** for SLA enforcement

```yaml
# project.yaml or org/workflows/swe-sdlc.yaml
workflow:
  name: swe-sdlc
  rejectionStrategy: origin    # Rejections always loop back to gate 1

  gates:
    - id: implement
      role: developer
      description: "Implement with tests"
      timeout: 4h
      escalateTo: architect

    - id: code-review
      role: reviewer
      canReject: true
      description: "Review code quality and architecture"
      timeout: 2h
      escalateTo: tech-lead

    - id: qa
      role: qa
      canReject: true
      description: "Run tests and validate acceptance criteria"
      timeout: 3h
```

## Task Frontmatter for Gates

When a task enters a workflow, two additional fields appear in its frontmatter:

```yaml
gate:
  current: implement          # Active gate ID
  entered: 2026-02-21T10:00Z # When task entered this gate

gateHistory:
  - gateId: implement
    enteredAt: 2026-02-21T10:00Z
    completedAt: 2026-02-21T12:00Z
    actor: swe-backend
    outcome: complete

reviewContext:
  rejectedAt: 2026-02-21T12:05Z
  rejectedBy: swe-architect
  rejectedFrom: code-review
  blockers:
    - "Missing error handling in auth flow"
    - "Test coverage below 80%"
```

## Completing a Gate Task

Gate tasks require the `outcome` parameter when calling `aof_task_complete`:

```json
{
  "tool": "aof_task_complete",
  "params": {
    "taskId": "TASK-2026-02-21-001",
    "outcome": "complete",
    "summary": "Implemented auth with full test coverage",
    "actor": "swe-backend",
    "callerRole": "developer"
  }
}
```

### Valid Outcomes

| Outcome | Effect | Requirements |
|---------|--------|-------------|
| `"complete"` | Advance to next gate (or `done` if last gate) | `summary` |
| `"needs_review"` | Reject back to origin gate | `blockers` (list of issues to fix) |
| `"blocked"` | Hold in current gate (external dependency) | `blockers` (what's blocking) |

<Aside type="caution">
Omitting `outcome` on a gated task will fail with a teaching error that explains what's needed. Omitting `callerRole` allows the transition without role validation — only do this for backwards compatibility; new code should always supply `callerRole`.
</Aside>

## Role Enforcement

The gate evaluator checks that `callerRole` matches the gate's required `role`:

```yaml
# Gate requires "reviewer" role
- id: code-review
  role: reviewer
  canReject: true
```

```json
{
  "callerRole": "developer"
}
// → Error: Gate "code-review" requires role "reviewer", but caller declared role "developer"
```

This prevents a backend agent from approving its own code review, a QA agent from approving a security gate, etc.

## Rejection Loops

When a reviewer calls `aof_task_complete` with `outcome: "needs_review"`, the task loops back to the origin gate (the first gate in the workflow):

```json
{
  "tool": "aof_task_complete",
  "params": {
    "taskId": "TASK-2026-02-21-001",
    "outcome": "needs_review",
    "blockers": [
      "Missing error handling in auth flow",
      "No test for token expiration edge case"
    ],
    "summary": "Needs fixes before approval",
    "actor": "swe-reviewer",
    "callerRole": "reviewer"
  }
}
```

The task returns to `implement` with `reviewContext` populated so the implementing agent can see exactly what needs fixing.

## Conditional Gates

Gates can be conditionally skipped based on task metadata:

```yaml
gates:
  - id: implement
    role: developer

  - id: security-review
    role: security-engineer
    canReject: true
    description: "Security review for auth/payment changes"
    condition:
      # Only activate if task has these tags
      anyTag: [security, auth, payment]

  - id: code-review
    role: reviewer
    canReject: true
```

If a task's `routing.tags` doesn't include `security`, `auth`, or `payment`, the `security-review` gate is skipped automatically.

## Timeout and Escalation

Each gate can enforce an SLA with automatic escalation:

```yaml
- id: code-review
  role: reviewer
  canReject: true
  timeout: 2h                   # Gate must complete within 2 hours
  escalateTo: tech-lead         # Escalate to this role if timeout exceeded
```

When a gate exceeds its timeout:
1. A notification is sent to the escalation role
2. The task is re-routed to the `escalateTo` role if configured
3. A `gate.timeout` event is logged

## Full SDLC Example

```yaml
workflow:
  name: full-sdlc
  rejectionStrategy: origin

  gates:
    - id: implement
      role: backend
      description: "Implement feature with tests"
      timeout: 4h
      escalateTo: architect

    - id: code-review
      role: architect
      canReject: true
      description: "Architecture and code quality review"
      timeout: 2h

    - id: qa
      role: qa
      canReject: true
      description: "Quality assurance and testing"
      timeout: 3h

    - id: security-review
      role: security
      canReject: true
      description: "Security audit (API/auth changes only)"
      condition:
        anyTag: [api, auth, security]
      timeout: 4h

    - id: po-approval
      role: po
      canReject: true
      description: "Product owner sign-off"
      timeout: 24h
      escalateTo: vp

  outcomes:
    complete: advance
    needs_review: reject
    blocked: hold
```

## Gate History and Audit Trail

Every gate transition is recorded in `gateHistory`:

```yaml
gateHistory:
  - gateId: implement
    enteredAt: 2026-02-21T09:00Z
    completedAt: 2026-02-21T11:00Z
    actor: swe-backend
    outcome: complete

  - gateId: code-review
    enteredAt: 2026-02-21T11:05Z
    completedAt: 2026-02-21T12:00Z
    actor: swe-architect
    outcome: needs_review
    blockers:
      - "Missing error handling in auth flow"

  - gateId: implement
    enteredAt: 2026-02-21T12:05Z
    completedAt: 2026-02-21T13:30Z
    actor: swe-backend
    outcome: complete

  - gateId: code-review
    enteredAt: 2026-02-21T13:35Z
    completedAt: 2026-02-21T14:00Z
    actor: swe-architect
    outcome: complete
```

This provides a full audit trail of who did what and when at every stage.

<Aside type="tip">
See [Writing Custom Workflow Gates](/guides/custom-gates) for a guide on designing workflows for your specific process.
</Aside>
