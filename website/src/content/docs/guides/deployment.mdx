---
title: Deployment Guide
description: How to deploy AOF in plugin mode or standalone daemon mode, with conflict prevention and health checks.
sidebar:
  order: 1
---

import { Aside, Steps, Tabs, TabItem } from '@astrojs/starlight/components';

AOF runs in two modes. This guide covers both, plus how to avoid the most common operational mistake: running both simultaneously.

## Mode Overview

| | Plugin Mode | Standalone Daemon |
|--|-------------|-------------------|
| **Best for** | OpenClaw deployments | Non-OpenClaw, CI/CD |
| **Scheduler** | Runs inside OpenClaw gateway process | Separate daemon process |
| **Config** | `~/.openclaw/openclaw.json` | `~/.aof/config.json` |
| **Tool access** | Via OpenClaw gateway | Via HTTP API |
| **Management** | `openclaw gateway restart` | `aof daemon start/stop` |

<Aside type="caution" title="Critical: Never run both simultaneously">
The plugin scheduler and the standalone daemon both poll tasks and dispatch. If both run against the same `dataDir`, you will get double dispatches, lease conflicts, and corrupted state. Pick one mode per project.
</Aside>

---

## Plugin Mode (Recommended)

Plugin mode is the recommended approach when running OpenClaw. AOF registers as a plugin and runs inside the gateway process.

<Steps>

1. **Install or link AOF**

   Via npm:
   ```bash
   npm install -g aof
   ```

   Or link from source:
   ```bash
   cd ~/Projects/AOF
   npm run build
   npm link
   ```

2. **Run the integration wizard**

   ```bash
   aof init
   ```

   This registers AOF in `~/.openclaw/openclaw.json` automatically.

3. **Configure the plugin**

   Edit `~/.openclaw/openclaw.json`:

   ```json
   {
     "plugins": {
       "aof": {
         "enabled": true,
         "config": {
           "dryRun": false,
           "dataDir": "~/.openclaw/aof",
           "gatewayUrl": "http://127.0.0.1:18789",
           "gatewayToken": "your-token-here",
           "pollIntervalMs": 30000,
           "maxConcurrentDispatches": 3
         }
       }
     }
   }
   ```

4. **Restart the gateway**

   ```bash
   openclaw gateway restart
   ```

5. **Verify**

   ```bash
   openclaw gateway status
   # Should show aof plugin: loaded
   
   curl http://127.0.0.1:18789/aof/status
   # Should return scheduler status
   ```

</Steps>

### Plugin Mode Configuration Tips

**`dryRun` must be `false`** for active operation. The default is `false` in plugin mode, but double-check if tasks aren't being dispatched.

**Gateway token**: The plugin needs the gateway token to dispatch to agent sessions. Set `gatewayToken` explicitly, or the plugin will read `OPENCLAW_GATEWAY_TOKEN` from the environment.

**Data directory**: Use an absolute path for `dataDir` to avoid surprises with relative path resolution.

---

## Standalone Daemon Mode

Use this when you're not running OpenClaw, or for CI environments.

<Steps>

1. **Build AOF**

   ```bash
   git clone https://github.com/Seldon-Engine/aof.git
   cd aof
   npm install && npm run build
   ```

2. **Initialize a project**

   ```bash
   aof init --skip-openclaw
   ```

3. **Start the daemon**

   ```bash
   aof daemon start --port 18100 --data-dir ~/.aof
   ```

4. **Check status**

   ```bash
   aof daemon status
   # PID: 12345
   # Status: running
   # Uptime: 2m 30s
   # Last poll: 15s ago
   
   curl http://localhost:18100/health
   # {"status": "ok", "scheduler": "running"}
   ```

</Steps>

### Running as a System Service

**launchd (macOS):**

```xml
<!-- ~/Library/LaunchAgents/com.aof.daemon.plist -->
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "...">
<plist version="1.0">
<dict>
  <key>Label</key>
  <string>com.aof.daemon</string>
  <key>ProgramArguments</key>
  <array>
    <string>/usr/local/bin/aof</string>
    <string>daemon</string>
    <string>start</string>
    <string>--port</string>
    <string>18100</string>
  </array>
  <key>RunAtLoad</key>
  <true/>
  <key>KeepAlive</key>
  <true/>
  <key>StandardOutPath</key>
  <string>/tmp/aof-daemon.log</string>
  <key>StandardErrorPath</key>
  <string>/tmp/aof-daemon-error.log</string>
</dict>
</plist>
```

```bash
launchctl load ~/Library/LaunchAgents/com.aof.daemon.plist
```

**systemd (Linux):**

```ini
# /etc/systemd/system/aof-daemon.service
[Unit]
Description=AOF Daemon
After=network.target

[Service]
Type=simple
ExecStart=/usr/local/bin/aof daemon start --port 18100
Restart=always
RestartSec=5
User=aof
Environment=AOF_ROOT=/var/aof

[Install]
WantedBy=multi-user.target
```

```bash
systemctl enable aof-daemon
systemctl start aof-daemon
```

---

## Health Endpoint

Both modes expose a health endpoint:

```
GET /health
```

Response:
```json
{
  "status": "ok",
  "version": "0.1.0",
  "scheduler": {
    "status": "running",
    "lastPoll": "2026-02-21T15:00:00Z",
    "pollIntervalMs": 30000,
    "tasksDispatched": 147,
    "leaseExpirations": 3
  }
}
```

---

## Observability

### Prometheus Metrics

```bash
aof metrics serve --port 9090
```

Available at `http://localhost:9090/metrics`. Key metrics:

- `aof_tasks_total{status, priority}` — Task counts by status and priority
- `aof_dispatch_duration_ms` — Dispatch latency histogram
- `aof_scheduler_poll_duration_ms` — Poll cycle duration
- `aof_lease_expirations_total` — Lease expiration count

### Event Log

All state transitions are appended to `events/events.jsonl`:

```bash
tail -f ~/.openclaw/aof/events/events.jsonl | jq .
```

---

## Conflict Prevention Checklist

Before deploying, verify:

- [ ] Only one scheduler is active per `dataDir`
- [ ] `dryRun: false` in production config
- [ ] `dataDir` is an absolute path
- [ ] `gatewayToken` is set correctly
- [ ] `maxConcurrentDispatches` is appropriate for your agent count
- [ ] Health endpoint is responding
- [ ] `aof org validate` passes with no errors
