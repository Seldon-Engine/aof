# P2.1 Quick Start — OpenClaw Plugin Adapter

## For OpenClaw Plugin Users

### 1. Register the Plugin

```typescript
// In your OpenClaw plugin entrypoint:
import { registerAofPlugin } from 'aof';

export function activate(api: OpenClawApi) {
  const service = registerAofPlugin(api, {
    dataDir: '~/Projects/AOF',  // Your AOF root
    pollIntervalMs: 30_000,      // Poll every 30s (fallback)
    dryRun: false,               // Set to true for read-only
  });

  // Service starts automatically with Gateway
  // Stops automatically on Gateway shutdown
}
```

### 2. Use the Tools

**Update a task:**
```typescript
await api.callTool('aof_task_update', {
  taskId: 'TASK-2026-02-07-001',
  status: 'in-progress',
  body: 'Started work on this',
  actor: 'swe-backend',
  reason: 'picked_up',
});
```

**Report status:**
```typescript
const report = await api.callTool('aof_status_report', {
  agent: 'swe-backend',
});
console.log(report.total, report.byStatus);
```

**Complete a task:**
```typescript
await api.callTool('aof_task_complete', {
  taskId: 'TASK-2026-02-07-001',
  actor: 'swe-backend',
  summary: 'All acceptance criteria met.',
});
```

### 3. Use the CLI

```bash
openclaw aof lint          # Lint all task files
openclaw aof board         # Show task board (JSON)
openclaw aof drift         # Check org chart drift
openclaw aof config get memoryPools.hot.agents
```

### 4. Monitor via Gateway

```bash
# Prometheus metrics
curl http://localhost:3000/metrics

# Service health
curl http://localhost:3000/aof/status
```

---

## For Standalone Daemon Users (No OpenClaw)

### 1. Run the Daemon

```bash
# Dry-run mode (read-only)
npx aof-daemon --root ~/Projects/AOF --interval 30000

# Active mode (mutations enabled)
npx aof-daemon --root ~/Projects/AOF --interval 30000 --active
```

### 2. Graceful Shutdown

```bash
# Send SIGTERM or SIGINT (Ctrl+C)
kill -TERM <pid>
```

### 3. Logs

Event log: `~/Projects/AOF/events/YYYY-MM-DD.jsonl`

---

## For Developers

### Run Tests

```bash
npm test                 # Full suite (200 tests)
npm run test:watch       # Watch mode
```

### Build

```bash
npm run build           # Compile TypeScript
npm run typecheck       # Type-check only
```

### Smoke Test the Plugin

```typescript
// test/smoke-test.ts
import { registerAofPlugin } from '../src/index.js';

const mockApi = {
  registerService: (def) => console.log('Service:', def.name),
  registerTool: (def) => console.log('Tool:', def.name),
  registerCli: (def) => console.log('CLI:', def.name),
  registerGatewayMethod: (def) => console.log('Gateway:', def.method, def.path),
  on: (event, handler) => console.log('Event:', event),
};

registerAofPlugin(mockApi, { dataDir: '/tmp/aof' });
```

---

## Event-Driven Polling

**Triggers:**
- `session_end` — Agent session terminated
- `agent_end` — Specific agent shutdown
- `message_received` — Message sent/received
- `before_compaction` — Memory compaction (fallback only in 2026.2.6)
- **Interval fallback** — Every 30s (configurable)

**Behavior:**
- Sequential queue (no overlapping polls)
- <1s response time for event-driven triggers
- Metrics tracked: `aof_scheduler_loop_duration_seconds`

---

## Configuration Options

```typescript
interface AOFPluginOptions {
  dataDir: string;              // AOF root (required)
  pollIntervalMs?: number;      // Default: 30000
  defaultLeaseTtlMs?: number;   // Default: 600000 (10min)
  dryRun?: boolean;             // Default: true
  
  // Injectable (for testing):
  store?: TaskStore;
  logger?: EventLogger;
  metrics?: AOFMetrics;
  service?: AOFService;
}
```

---

## Troubleshooting

**Tests fail with "Task not found":**
- Ensure `store.init()` is called before tests
- Check `tmpDir` cleanup in `afterEach`

**Daemon doesn't poll:**
- Verify `--root` path exists
- Check event log for startup entry
- Ensure `pollIntervalMs > 0`

**Plugin doesn't register:**
- Verify OpenClaw API methods are available
- Check console for registration logs
- Ensure `dataDir` is writable

---

## Performance

**Benchmarks (on M1 Mac):**
- Poll cycle (20 tasks): <100ms
- Task update: <50ms
- Metrics collection: <10ms

**Scaling:**
- Tested up to 1000 tasks (no performance issues)
- Poll interval can be tuned per deployment
- Event-driven triggers add <1ms overhead
